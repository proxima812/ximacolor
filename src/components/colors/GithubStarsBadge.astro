---
interface Props {
	owner: string;
	repo: string;
}

const { owner, repo } = Astro.props;
const repoPath = `${owner}/${repo}`;
const repoUrl = `https://github.com/${repoPath}`;
const apiUrl = `https://api.github.com/repos/${repoPath}`;
const elementId = `gh-stars-${owner}-${repo}`.replace(/[^a-z0-9_-]/gi, "-");
const cacheKey = `gh-stars-cache:${repoPath}`;
---

<a
	class="inline-flex px-3 py-2 font-medium items-center text-sm bg-black text-white gap-2 rounded-full"
	href={repoUrl}
	target="_blank"
	rel="noreferrer noopener"
	aria-label={`Open GitHub repository ${repoPath}`}
>
	<svg aria-hidden="true" viewBox="0 0 24 24" class="h-3.5 w-3.5 fill-current">
		<path
			d="M12 0.3a12 12 0 0 0-3.8 23.4c0.6 0.1 0.8-0.2 0.8-0.6v-2.1c-3.4 0.7-4.1-1.5-4.1-1.5c-0.6-1.4-1.4-1.8-1.4-1.8c-1.2-0.8 0.1-0.8 0.1-0.8c1.3 0.1 2 1.3 2 1.3c1.2 2 3.1 1.4 3.9 1.1c0.1-0.8 0.4-1.4 0.8-1.7c-2.7-0.3-5.6-1.3-5.6-6A4.7 4.7 0 0 1 5.9 7c-0.1-0.3-0.5-1.6 0.1-3.4c0 0 1-0.3 3.3 1.3a11.3 11.3 0 0 1 6 0C17.6 3.3 18.6 3.6 18.6 3.6c0.6 1.8 0.2 3.1 0.1 3.4a4.7 4.7 0 0 1 1.2 3.2c0 4.7-2.9 5.7-5.7 6c0.5 0.4 0.9 1.2 0.9 2.4v3.6c0 0.3 0.2 0.7 0.8 0.6A12 12 0 0 0 12 0.3"
		></path>
	</svg>
	<span>{repoPath}</span>
	<span class="text-zinc-500" aria-hidden="true">‚≠ê</span>
	<span class="font-bold" id={elementId} data-api={apiUrl} aria-live="polite"> ... </span>
</a>

<script is:inline define:vars={{ elementId, cacheKey }}>
	(() => {
		const cacheTtlMs = 1000 * 60 * 60 * 24 * 3;
		const target = document.getElementById(elementId);
		if (!target) return;

		const api = target.getAttribute("data-api");
		if (!api) return;
		const formatStars = (count) => new Intl.NumberFormat("en-US").format(count);
		let staleStars = null;

		try {
			const cachedRaw = localStorage.getItem(cacheKey);
			if (cachedRaw) {
				const cached = JSON.parse(cachedRaw);
				if (
					cached &&
					typeof cached.stars === "number" &&
					typeof cached.timestamp === "number"
				) {
					staleStars = cached.stars;
					target.textContent = formatStars(cached.stars);
					if (Date.now() - cached.timestamp < cacheTtlMs) {
						return;
					}
				}
			}
		} catch {}

		fetch(api, { headers: { Accept: "application/vnd.github+json" } })
			.then((response) => (response.ok ? response.json() : null))
			.then((data) => {
				if (!data || typeof data.stargazers_count !== "number") {
					target.textContent = staleStars === null ? "--" : formatStars(staleStars);
					return;
				}

				target.textContent = formatStars(data.stargazers_count);
				try {
					localStorage.setItem(
						cacheKey,
						JSON.stringify({
							stars: data.stargazers_count,
							timestamp: Date.now(),
						}),
					);
				} catch {}
			})
			.catch(() => {
				target.textContent = staleStars === null ? "--" : formatStars(staleStars);
			});
	})();
</script>
